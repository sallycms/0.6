<?php
/*
 * Copyright (C) 2009 REDAXO
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License Version 2 as published by the
 * Free Software Foundation.
 */

////////////////////////////////////////////////////////
// print breadcrumb path

$base     = 'index.php?page=mediapool&amp;subpage=structure&amp;cat_id=';
$textpath = '<li> : <a href="'.$base.'0">Start</a></li>';
$catID    = sly_request('cat_id', 'int');
$ooCat    = $catID > 0 ? OOMediaCategory::getCategoryById($catID) : null;

if ($ooCat === null) {
	$categories = OOMediaCategory::getRootCategories();
	$catID      = 0;
	$catPath    = '|';
}
else {
	$categories = $ooCat->getChildren();
	$parents    = $ooCat->getParentTree();

	foreach ($parents as $parent) {
		$textpath .= '<li> : <a href="'.$base.$parent->getId().'">'.sly_html($parent->getName()).'</a></li>';
	}

	$textpath .= '<li> : <a href="'.$base.$catID.'">'.sly_html($ooCat->getName()).'</a></li>';
	$catPath   = $ooCat->getPath().$catID.'|';
}

?>
<div class="sly-navi-path">
	<ul>
		<li><?= t('pool_kat_path') ?></li>
		<?= $textpath ?>
	</ul>
</div>
<?php

////////////////////////////////////////////////////////
// info and error messages

$this->render('views/mediapool/notices.phtml');

////////////////////////////////////////////////////////
// start form if needed

$editID = sly_request('edit_id', 'int');

if ($this->action == 'add' || $this->action == 'edit') {
	$addMode = $this->action == 'add';
	$legend  = $addMode ? t('pool_kat_create_label') : t('pool_kat_edit');

	$form = new sly_Form('index.php', 'POST', '');
	$form->addHiddenValue('page', 'mediapool');
	$form->addHiddenValue('subpage', 'structure');
	$form->addHiddenValue('cat_id', $catID);
	$form->addHiddenValue('catpath', $catPath); // that's braindead
	$form->addHiddenValue('func', $this->action);

	if ($this->action) {
		$form->addHiddenValue('edit_id', $editID);
	}

	// additional arguments

	foreach ($this->args as $name => $value) {
		$form->addHiddenValue('args['.$name.']', $value);
	}

	$form->beginFieldset($legend, 'sly-mediapool-structure-form');
	ob_start();
}

?>
<table class="rex-table" id="sly-mediapool-structure" summary="<?= sly_html(t('pool_kat_summary')) ?>">
	<caption class="rex-hide"><?= sly_html(t('pool_kat_caption')) ?></caption>
	<colgroup>
		<col width="40" />
		<col width="40" />
		<col width="*" />
		<col width="77" />
		<col width="76" />
	</colgroup>
	<thead><tr>
		<th class="sly-icon">
			<a class="rex-i-element rex-i-mediapool-category-add sly-sprite" href="<?= $base.$catID ?>&amp;func=add">
				<span class="rex-i-element-text"><?= t('pool_kat_create') ?></span>
			</a>
		</th>
		<th class="rex-small">ID</th>
		<th><?= t('pool_kat_name') ?></th>
		<th colspan="2"><?= t('pool_kat_function') ?></th>
	</tr></thead>
	<tbody><?php

	if ($this->action == 'add') {
		?><tr class="rex-table-row-activ">
			<td class="sly-icon"><span class="rex-i-element rex-i-mediapool-category sly-sprite"><span class="rex-i-element-text"><?= t('pool_kat_create') ?></span></span></td>
			<td class="rex-small">-</td>
			<td>
				<label class="rex-form-hidden-label" for="rex-form-field-name"><?= t('pool_kat_name') ?></label>
				<input class="rex-form-text" type="text" size="10" id="rex-form-field-name" name="catname" value="" />
			</td>
			<td colspan="2">
				<input type="submit" class="rex-form-submit" value="<?= t('pool_kat_create') ?>" />
			</td>
		</tr><?php
	}

	foreach ($categories as $cat) {
		$id = $cat->getId();

		if ($this->action == 'edit' && $editID == $id) {
			?><tr class="rex-table-row-activ">
			<td class="sly-icon"><span class="rex-i-element rex-i-mediapool-category sly-sprite"><span class="rex-i-element-text"><?= sly_html($cat->getName())?></span></span></td>
			<td class="rex-small"><?= $id ?></td>
			<td>
				<label class="rex-form-hidden-label" for="rex-form-field-name"><?= t('pool_kat_name') ?></label>
				<input class="rex-form-text" type="text" id="rex-form-field-name" name="catname" value="<?= sly_html($cat->getName()) ?>" />
			</td>
			<td colspan="2">
				<input type="submit" class="rex-form-submit" value="<?= t('pool_kat_update') ?>" />
			</td>
			</tr><?php
		}
		else {
			?><tr>
			<td class="sly-icon"><a class="rex-i-element rex-i-mediapool-category sly-sprite" href="<?= $base.$id ?>"><span class="rex-i-element-text"><?= sly_html($cat->getName())?></span></a></td>
			<td class="rex-small"><?= $id ?></td>
			<td><a href="<?= $base.$id ?>"><?= sly_html($cat->getName()) ?></a></td>
			<td><a href="<?= $base.$catID ?>&amp;func=edit&amp;edit_id=<?= $id ?>"><?= t('pool_kat_edit')?></a></td>
			<td><a href="<?= $base.$catID ?>&amp;func=delete&amp;edit_id=<?= $id ?>" class="sly-delete"><?= t('pool_kat_delete') ?></a></td>
			</tr><?php
		}
	}

	?></tbody>
</table>

<?php

if ($this->action == 'add' || $this->action == 'edit') {
	$container = new sly_Form_Container();
	$container->setContent(ob_get_clean());

	$form->add($container);
	$form->setResetButton(null);
	$form->setSubmitButton(null);
	$form->render();
}
